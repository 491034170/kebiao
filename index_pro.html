<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>æˆ‘çš„è¯¾è¡¨ Â· äº¤äº’ + .icså¯¼å‡º + Excelå¯¼å…¥</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    .grid-timetable { display: grid; grid-template-columns: 90px repeat(7, 1fr); gap: 6px; }
    .cell { min-height: 64px; border-radius: 12px; padding: 8px; background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.08); }
    .cell.now { outline: 2px solid #60a5fa; box-shadow: 0 0 0 3px rgba(96,165,250,0.3); }
    .chip { display:inline-block; padding:2px 8px; border-radius:9999px; background:rgba(255,255,255,0.08); font-size:12px; }
    dialog::backdrop { background: rgb(2 6 23 / 0.6); }
    dialog { border:1px solid rgb(255 255 255 / 0.1); border-radius:16px; padding:0; max-width:900px; width:95vw; color:#e5e7eb; }
    .modal-h { padding:14px 16px; border-bottom:1px solid rgb(255 255 255 / 0.08); background:#0b1220; }
    .modal-b { padding:16px; background:#0b1220; }
  
    /* ğŸ”¥ æ–°å¢ï¼šç»Ÿä¸€ select å’Œ option çš„æ·±è‰²æ ·å¼ */
    select {
      color: #f8fafc;           /* æµ…è‰²æ–‡å­— */
      background-color: #1e293b; /* slate-800 */
    }
    option {
      background-color: #1e293b;
      color: #f8fafc;
    }
  </style>
</head>
<body class="bg-slate-950 text-slate-100">
  <header class="sticky top-0 z-10 backdrop-blur bg-slate-950/70 border-b border-white/10">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center gap-3">
      <h1 class="text-xl font-semibold">æˆ‘çš„è¯¾è¡¨ Â· äº¤äº’ + .icså¯¼å‡º + Excelå¯¼å…¥</h1>
      <span id="todayBadge" class="chip"></span>
      <div class="ml-auto flex gap-2">
        <button id="importBtn" class="px-3 py-1.5 rounded-lg bg-white/10 hover:bg-white/20">å¯¼å…¥Excel/CSV</button>
        <button id="icsBtn" class="px-3 py-1.5 rounded-lg bg-white/10 hover:bg-white/20">å¯¼å‡º .ics</button>
        <button id="viewGrid" class="px-3 py-1.5 rounded-lg bg-white/10 hover:bg-white/20">ç½‘æ ¼è§†å›¾</button>
        <button id="viewList" class="px-3 py-1.5 rounded-lg bg-white/10 hover:bg-white/20">åˆ—è¡¨è§†å›¾</button>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 py-6 space-y-6">
    <section class="rounded-2xl border border-white/10 p-4 bg-white/5">
      <div class="grid md:grid-cols-5 gap-3">
        <div>
          <label class="block text-sm text-slate-300 mb-1">æœç´¢è¯¾ç¨‹/æ•™å¸ˆ/æ•™å®¤</label>
          <input id="q" type="text" placeholder="è¾“å…¥å…³é”®è¯..." class="w-full px-3 py-2 bg-white/10 rounded-lg outline-none focus:ring ring-blue-400/50">
        </div>
        <div>
          <label class="block text-sm text-slate-300 mb-1">æ˜ŸæœŸ</label>
          <select id="weekday" class="w-full px-3 py-2 bg-white/10 text-slate-100 rounded-lg">
            <option value="">å…¨éƒ¨</option>
            <option value="1">å‘¨ä¸€</option><option value="2">å‘¨äºŒ</option><option value="3">å‘¨ä¸‰</option>
            <option value="4">å‘¨å››</option><option value="5">å‘¨äº”</option><option value="6">å‘¨å…­</option><option value="7">å‘¨æ—¥</option>
          </select>
        </div>
        <div>
          <label class="block text-sm text-slate-300 mb-1">æ•™å¸ˆ</label>
          <select id="teacher" class="w-full px-3 py-2 bg-white/10 rounded-lg"><option value="">å…¨éƒ¨</option></select>
        </div>
        <div>
          <label class="block text-sm text-slate-300 mb-1">æ•™å®¤</label>
          <select id="room" class="w-full px-3 py-2 bg-white/10 rounded-lg"><option value="">å…¨éƒ¨</option></select>
        </div>
        <div class="grid grid-cols-2 gap-2 items-end">
          <label class="inline-flex items-center gap-2">
            <input id="groupSame" type="checkbox" class="accent-blue-500">
            åˆå¹¶ç›¸åŒè¯¾ç¨‹
          </label>
          <label class="inline-flex items-center gap-2">
            <input id="highlightToday" type="checkbox" class="accent-blue-500" checked>
            é«˜äº®ä»Šå¤©
          </label>
        </div>
      </div>
    </section>

    <section id="gridView" class="space-y-3">
      <div class="grid grid-cols-8 gap-2 text-sm font-medium text-slate-300">
        <div></div><div class="text-center">å‘¨ä¸€</div><div class="text-center">å‘¨äºŒ</div><div class="text-center">å‘¨ä¸‰</div>
        <div class="text-center">å‘¨å››</div><div class="text-center">å‘¨äº”</div><div class="text-center">å‘¨å…­</div><div class="text-center">å‘¨æ—¥</div>
      </div>
      <div id="grid" class="grid-timetable"></div>
    </section>

    <section id="listView" class="hidden">
      <div id="list" class="divide-y divide-white/10 rounded-xl border border-white/10 overflow-hidden"></div>
    </section>
  </main>

  <!-- Import dialog -->
  <dialog id="importDlg">
    <div class="modal-h flex items-center justify-between">
      <div class="font-semibold">å¯¼å…¥ Excel/CSV å¹¶åˆ·æ–°æ•°æ®</div>
      <button onclick="document.getElementById('importDlg').close();" class="px-2 py-1 rounded bg-white/10 hover:bg-white/20">å…³é—­</button>
    </div>
    <div class="modal-b space-y-4">
      <input id="fileInput" type="file" accept=".xlsx,.xls,.csv" class="block w-full text-sm text-slate-300">
      <div class="text-sm text-slate-300">è‡ªåŠ¨è¯†åˆ«å­—æ®µå¤±è´¥æ—¶ï¼Œè¯·åœ¨ä¸‹æ–¹æ‰‹åŠ¨æŒ‡å®šå¯¹åº”åˆ—ï¼š</div>
      <div id="mapping" class="grid grid-cols-2 md:grid-cols-3 gap-3"></div>
      <div class="text-right">
        <button id="applyImport" class="px-3 py-1.5 rounded-lg bg-blue-500/80 hover:bg-blue-500">å¯¼å…¥å¹¶åˆ·æ–°</button>
      </div>
      <div class="text-xs text-slate-400">æç¤ºï¼šè¯†åˆ«é€»è¾‘ä¼šå°è¯•ç†è§£â€œè¯¾ç¨‹/æ•™å¸ˆ/æ•™å®¤/æ˜ŸæœŸ/èŠ‚æ¬¡/æ—¶é—´/å‘¨ä¸€..å‘¨æ—¥åˆ—â€ç­‰å¸¸è§å†™æ³•ã€‚</div>
    </div>
  </dialog>

  <!-- ICS dialog -->
  <dialog id="icsDlg">
    <div class="modal-h flex items-center justify-between">
      <div class="font-semibold">å¯¼å‡º .ics è®¾ç½®</div>
      <button onclick="document.getElementById('icsDlg').close();" class="px-2 py-1 rounded bg-white/10 hover:bg-white/20">å…³é—­</button>
    </div>
    <div class="modal-b space-y-4">
      <div class="grid md:grid-cols-3 gap-4">
        <div>
          <label class="block text-sm text-slate-300 mb-1">å­¦æœŸå¼€å§‹æ—¥æœŸ</label>
          <input id="termStart" type="date" class="w-full px-3 py-2 bg-white/10 rounded">
        </div>
        <div>
          <label class="block text-sm text-slate-300 mb-1">å‘¨æ•°</label>
          <input id="termWeeks" type="number" value="16" min="1" max="30" class="w-full px-3 py-2 bg-white/10 rounded">
        </div>
        <div>
          <label class="block text-sm text-slate-300 mb-1">æ—¶åŒº</label>
          <input id="tz" type="text" value="Asia/Shanghai" class="w-full px-3 py-2 bg-white/10 rounded">
        </div>
      </div>
      <div>
        <div class="text-sm text-slate-300 mb-2">èŠ‚æ¬¡æ—¶é—´ï¼ˆå¯ä¿®æ”¹ï¼‰ï¼š</div>
        <div id="periodTable" class="grid sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2"></div>
      </div>
      <div class="text-right">
        <button id="exportICS" class="px-3 py-1.5 rounded-lg bg-emerald-500/80 hover:bg-emerald-500">å¯¼å‡º .ics</button>
      </div>
      <div class="text-xs text-slate-400">è¯´æ˜ï¼šè‹¥è¯¾ç¨‹çš„â€œèŠ‚æ¬¡â€æ˜¯â€œ1-2â€ï¼Œå°†ä½¿ç”¨ç¬¬1ã€2èŠ‚çš„èµ·æ­¢æ—¶é—´æ‹¼æ¥ã€‚å¦‚æ— èŠ‚æ¬¡ï¼Œå°†å°è¯•åŒ¹é…è¯¾ç¨‹æ—¶é—´æ–‡æœ¬ï¼›è‹¥ä»æ— æ³•åŒ¹é…ï¼Œä½¿ç”¨é»˜è®¤1-2èŠ‚ã€‚</div>
    </div>
  </dialog>

  <script id="data" type="application/json">
[
  {
    "course": "ç®—æ³•è®¾è®¡ä¸åˆ†æ",
    "teacher": "å­™æ€è‰³",
    "room": "1206",
    "weekday_num": 2,
    "weekday_label": "å‘¨äºŒ",
    "period": "1",
    "raw_period": null
  },
  {
    "course": "ç®—æ³•è®¾è®¡ä¸åˆ†æ",
    "teacher": "å­™æ€è‰³",
    "room": "1206",
    "weekday_num": 7,
    "weekday_label": "å‘¨æ—¥",
    "period": "1",
    "raw_period": null
  },
  {
    "course": "æ•°æ®åº“æŠ€æœ¯åº”ç”¨",
    "teacher": "å•ç¼å",
    "room": "1203",
    "weekday_num": 1,
    "weekday_label": "å‘¨ä¸€",
    "period": "1",
    "raw_period": null
  },
  {
    "course": "æ•°æ®åº“æŠ€æœ¯åº”ç”¨",
    "teacher": "å•ç¼å",
    "room": "1203",
    "weekday_num": 2,
    "weekday_label": "å‘¨äºŒ",
    "period": "7",
    "raw_period": null
  },
  {
    "course": "æ•°æ®åº“æŠ€æœ¯åº”ç”¨",
    "teacher": "å•ç¼å",
    "room": "1203",
    "weekday_num": 7,
    "weekday_label": "å‘¨æ—¥",
    "period": "7",
    "raw_period": null
  },
  {
    "course": "æ“ä½œç³»ç»Ÿ",
    "teacher": "å­™é¹¤",
    "room": "D601",
    "weekday_num": 5,
    "weekday_label": "å‘¨äº”",
    "period": "5",
    "raw_period": null
  },
  {
    "course": "JSPç¨‹åºè®¾è®¡",
    "teacher": "å‘¨éœ²è·š",
    "room": "1203",
    "weekday_num": 1,
    "weekday_label": "å‘¨ä¸€",
    "period": "5",
    "raw_period": null
  },
  {
    "course": "JSPç¨‹åºè®¾è®¡",
    "teacher": "å‘¨éœ²è·š",
    "room": "D601",
    "weekday_num": 2,
    "weekday_label": "å‘¨äºŒ",
    "period": "9",
    "raw_period": null
  },
  {
    "course": "JSPç¨‹åºè®¾è®¡",
    "teacher": "å‘¨éœ²è·š",
    "room": "D601",
    "weekday_num": 7,
    "weekday_label": "å‘¨æ—¥",
    "period": "9",
    "raw_period": null
  },
  {
    "course": "è®¡ç®—æœºå›¾å½¢å­¦",
    "teacher": "éŸ©ä¼¯æº",
    "room": "1204",
    "weekday_num": 1,
    "weekday_label": "å‘¨ä¸€",
    "period": "9",
    "raw_period": null
  },
  {
    "course": "è®¡ç®—æœºå›¾å½¢å­¦",
    "teacher": "éŸ©ä¼¯æº",
    "room": "S305",
    "weekday_num": 1,
    "weekday_label": "å‘¨ä¸€",
    "period": "11",
    "raw_period": null
  },
  {
    "course": "ç ”ç©¶ç”Ÿå…¥å­¦è€ƒè¯•è‹±è¯­å¤‡è€ƒæŒ‡å—",
    "teacher": "ä½™æ³¢",
    "room": "S405",
    "weekday_num": 3,
    "weekday_label": "å‘¨ä¸‰",
    "period": "9",
    "raw_period": null
  },
  {
    "course": "ç ”ç©¶ç”Ÿå…¥å­¦è€ƒè¯•è‹±è¯­å¤‡è€ƒæŒ‡å—",
    "teacher": "ä½™æ³¢",
    "room": "S405",
    "weekday_num": 6,
    "weekday_label": "å‘¨å…­",
    "period": "9",
    "raw_period": null
  },
  {
    "course": "ç½‘é¡µè®¾è®¡ä¸åˆ¶ä½œ",
    "teacher": "å­™ä»•äº‘",
    "room": "D602",
    "weekday_num": 6,
    "weekday_label": "å‘¨å…­",
    "period": "7",
    "raw_period": null
  },
  {
    "course": "åˆ›æ–°åˆ›ä¸šå®è·µæ¨¡å—äº”ï¼šå•†ä¸šè®¡åˆ’ä¹¦æ’°å†™",
    "teacher": "ææ€è“‰",
    "room": "C216",
    "weekday_num": 1,
    "weekday_label": "å‘¨ä¸€",
    "period": "3",
    "raw_period": null
  },
  {
    "course": "åˆ›æ–°åˆ›ä¸šå®è·µæ¨¡å—äº”ï¼šå•†ä¸šè®¡åˆ’ä¹¦æ’°å†™",
    "teacher": "ææ€è“‰",
    "room": "C112",
    "weekday_num": 4,
    "weekday_label": "å‘¨å››",
    "period": "5",
    "raw_period": null
  },
  {
    "course": "åˆ›æ–°åˆ›ä¸šå®è·µæ¨¡å—å…­ï¼šå¼€å±•åˆ›ä¸šèèµ„",
    "teacher": "ææ€è“‰",
    "room": "C217",
    "weekday_num": 5,
    "weekday_label": "å‘¨äº”",
    "period": "5",
    "raw_period": null
  },
  {
    "course": "å¤§å­¦ç”ŸèŒä¸šç”Ÿæ¶¯è§„åˆ’ä¸å°±ä¸šæŒ‡å¯¼è¯¾ï¼ˆäº”ï¼‰æ±‚èŒå‡†å¤‡ä¸æŠ€å·§",
    "teacher": "æå†°äº‘",
    "room": "C217",
    "weekday_num": 3,
    "weekday_label": "å‘¨ä¸‰",
    "period": "1",
    "raw_period": null
  },
  {
    "course": "å½¢åŠ¿ä¸æ”¿ç­–ï¼ˆ5ï¼‰",
    "teacher": "æ¨é›„è‹±",
    "room": "S309",
    "weekday_num": 4,
    "weekday_label": "å‘¨å››",
    "period": "9",
    "raw_period": null
  }
]
  </script>
  <script>
    // ---------- State & utils ----------
    let data = JSON.parse(document.getElementById('data').textContent).filter(x=>x.course);
    const $ = sel => document.querySelector(sel);

    // default period time mapping (24h HH:MM)
    const defaultTimes = {
      1:['08:00','08:45'], 2:['08:55','09:40'],
      3:['10:00','10:45'], 4:['10:55','11:40'],
      5:['14:00','14:45'], 6:['14:55','15:40'],
      7:['16:00','16:45'], 8:['16:55','17:40'],
      9:['19:00','19:45'],10:['19:55','20:40'],
      11:['20:50','21:35'],12:['21:40','22:25']
    };

    function uniq(arr){ return [...new Set(arr)]; }
    function safe(str){ return (str??'').toString(); }
    function parsePeriodLabel(label){
      if(!label) return null;
      const m = safe(label).match(/(\d{1,2})(?:-(\d{1,2}))?/);
      if(!m) return null;
      const a = parseInt(m[1],10);
      const b = m[2] ? parseInt(m[2],10) : a;
      return {start:a, end:b};
    }
    const weekdayNames = ['','å‘¨ä¸€','å‘¨äºŒ','å‘¨ä¸‰','å‘¨å››','å‘¨äº”','å‘¨å…­','å‘¨æ—¥'];

    // ---------- Filters / view ----------
    const state = { q:'', weekday:'', teacher:'', room:'', group:false, highlight:true, view:'grid' };
    const grid = $('#grid'); const list = $('#list');

    function setTodayBadge(){
      const now = new Date();
      const days = ['å‘¨æ—¥','å‘¨ä¸€','å‘¨äºŒ','å‘¨ä¸‰','å‘¨å››','å‘¨äº”','å‘¨å…­'];
      $('#todayBadge').textContent = days[now.getDay()] + ' ' + now.toLocaleTimeString();
    }
    setInterval(setTodayBadge, 1000); setTodayBadge();

    function refreshFacetOptions(){
      const teachers = uniq(data.map(x=>x.teacher).filter(Boolean)).sort();
      const rooms = uniq(data.map(x=>x.room).filter(Boolean)).sort();
      const tSel = $('#teacher'); const rSel = $('#room');
      tSel.innerHTML = '<option value="">å…¨éƒ¨</option>' + teachers.map(t=>`<option>${t}</option>`).join('');
      rSel.innerHTML = '<option value="">å…¨éƒ¨</option>' + rooms.map(r=>`<option>${r}</option>`).join('');
    }

    function periodsList(){
      let periods = uniq(data.map(x=>x.period).filter(Boolean));
      if (periods.length === 0) periods = Array.from({length:10}, (_,i)=>String(i+1));
      periods.sort((a,b)=>{
        const A=parseInt(String(a).split('-')[0])||999;
        const B=parseInt(String(b).split('-')[0])||999;
        return A-B;
      });
      return periods;
    }

    function filterData(){
      const kw = state.q.trim().toLowerCase();
      return data.filter(item=>{
        if (state.weekday && String(item.weekday_num||'') !== String(state.weekday)) return false;
        if (state.teacher && (item.teacher||'') !== state.teacher) return false;
        if (state.room && (item.room||'') !== state.room) return false;
        if (kw){
          const blob = [item.course, item.teacher, item.room, item.period].filter(Boolean).join(' ').toLowerCase();
          if (!blob.includes(kw)) return false;
        }
        return true;
      });
    }

    function groupKey(x){ return [x.weekday_num, x.period, x.course, x.teacher, x.room].map(v=>v||'').join('|'); }

    function renderGrid(){
      grid.innerHTML='';
      const periods = periodsList();
      periods.forEach(p=>{
        grid.insertAdjacentHTML('beforeend', `<div class="text-sm text-slate-400 flex items-center justify-center">${p}</div>`);
        for (let w=1; w<=7; w++){
          const cell = document.createElement('div'); cell.className='cell';
          const items = filterData().filter(x=>(x.weekday_num===w) && (String(x.period||'')===String(p)));
          const list = state.group ? Object.values(Object.groupBy(items, groupKey)).map(arr=>arr[0]) : items;
          cell.innerHTML = list.map(it=>`
            <div class="mb-2 last:mb-0">
              <div class="font-semibold">${safe(it.course)||'æœªå‘½åè¯¾ç¨‹'}</div>
              <div class="text-xs text-slate-300">${[safe(it.teacher)||'', safe(it.room)||''].filter(Boolean).join(' Â· ')}</div>
            </div>`).join('');
          const today = new Date().getDay();
          if (state.highlight && ((today===0?7:today)===w)) cell.classList.add('now');
          grid.appendChild(cell);
        }
      });
    }

    function renderList(){
      list.innerHTML='';
      const items = filterData().slice().sort((a,b)=>{
        const wa=(a.weekday_num||9)-(b.weekday_num||9);
        if (wa!==0) return wa;
        const pa=(parseInt(String(a.period||'').split('-')[0])||99)-(parseInt(String(b.period||'').split('-')[0])||99);
        if (pa!==0) return pa;
        return String(a.course).localeCompare(String(b.course));
      });
      if (items.length===0){ list.innerHTML='<div class="p-6 text-slate-400 text-center">æ²¡æœ‰åŒ¹é…çš„è¯¾ç¨‹</div>'; return; }
      items.forEach(it=>{
        const wlabel = it.weekday_label || (it.weekday_num ? weekdayNames[it.weekday_num] : 'æœªçŸ¥');
        list.insertAdjacentHTML('beforeend', `
          <div class="p-3 hover:bg-white/5">
            <div class="text-sm text-slate-400">${wlabel} Â· ${it.period||'æ—¶æ®µæœªçŸ¥'}</div>
            <div class="text-lg font-semibold">${safe(it.course)}</div>
            <div class="text-sm text-slate-300">${[safe(it.teacher)||'', safe(it.room)||''].filter(Boolean).join(' Â· ')}</div>
          </div>`);
      });
    }
    function render(){ state.view==='grid' ? (document.querySelector('#gridView').classList.remove('hidden'), document.querySelector('#listView').classList.add('hidden'), renderGrid())
                                         : (document.querySelector('#listView').classList.remove('hidden'), document.querySelector('#gridView').classList.add('hidden'), renderList()); }

    // controls
    document.getElementById('q').addEventListener('input', e=>{ state.q=e.target.value; render(); });
    document.getElementById('weekday').addEventListener('change', e=>{ state.weekday=e.target.value; render(); });
    document.getElementById('teacher').addEventListener('change', e=>{ state.teacher=e.target.value; render(); });
    document.getElementById('room').addEventListener('change', e=>{ state.room=e.target.value; render(); });
    document.getElementById('groupSame').addEventListener('change', e=>{ state.group=e.target.checked; render(); });
    document.getElementById('highlightToday').addEventListener('change', e=>{ state.highlight=e.target.checked; render(); });
    document.getElementById('viewGrid').addEventListener('click', ()=>{ state.view='grid'; render(); });
    document.getElementById('viewList').addEventListener('click', ()=>{ state.view='list'; render(); });
    refreshFacetOptions(); render();

    // ---------- Import Excel/CSV ----------
    document.getElementById('importBtn').addEventListener('click', ()=>{ $('#importDlg').showModal(); });
    document.getElementById('applyImport').addEventListener('click', ()=>{
      alert('è¯·é€‰æ‹©æ–‡ä»¶å¹¶ç­‰å¾…è§£æï¼Œè‡ªåŠ¨è¯†åˆ«æˆ–æ‰‹åŠ¨æ˜ å°„åå†ç‚¹å‡»å¯¼å…¥ã€‚');
    });
    document.getElementById('fileInput').addEventListener('change', async (e)=>{
      const file = e.target.files[0]; if(!file) return;
      const buf = await file.arrayBuffer();
      let rows = [];
      if (file.name.endsWith('.csv')){
        const text = new TextDecoder('utf-8').decode(new Uint8Array(buf));
        const wb = XLSX.read(text, {type:'string'});
        rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {defval:''});
      } else {
        const wb = XLSX.read(buf, {type:'array'});
        // concat all sheets
        wb.SheetNames.forEach(sn=>{
          const arr = XLSX.utils.sheet_to_json(wb.Sheets[sn], {defval:''});
          rows = rows.concat(arr.map(r=>({...r,_sheet:sn})));
        });
      }
      // build column select UI
      const cols = Object.keys(rows[0]||{});
      const mapping = $('#mapping');
      mapping.innerHTML='';
      const fields = [
        ['course','è¯¾ç¨‹åç§°(å¿…é€‰)'],
        ['teacher','æ•™å¸ˆ(å¯é€‰)'],
        ['room','æ•™å®¤(å¯é€‰)'],
        ['weekday','æ˜ŸæœŸ/å‘¨å‡ (å¯é€‰)'],
        ['period','èŠ‚æ¬¡/æ—¶æ®µ(å¯é€‰)'],
        ['time','æ—¶é—´æ–‡æœ¬(å¯é€‰)']
      ];
      for (const [key,label] of fields){
        const sel = document.createElement('div');
        sel.innerHTML = `<label class="block text-sm mb-1">${label}</label>
          <select data-key="${key}" class="w-full px-3 py-2 bg-white/10 rounded">
            <option value="">è‡ªåŠ¨è¯†åˆ«</option>
            ${cols.map(c=>`<option value="${c}">${c}</option>`).join('')}
          </select>`;
        mapping.appendChild(sel);
      }

      function guessCol(name){
        const pat = {
          course: /(è¯¾ç¨‹|è¯¾ç¨‹åç§°|è¯¾ç¨‹å|è¯¾å|ç§‘ç›®|course|subject)/i,
          teacher: /(æ•™å¸ˆ|ä»»è¯¾|è€å¸ˆ|teacher|è®²å¸ˆ)/i,
          room: /(æ•™å®¤|åœ°ç‚¹|room|location)/i,
          weekday: /(æ˜ŸæœŸ|å‘¨[ä¸€äºŒä¸‰å››äº”å…­æ—¥å¤©1234567]|weekday|å‘¨å‡ )/i,
          period: /(èŠ‚æ¬¡|èŠ‚|period|èŠ‚æ•°|èŠ‚æ®µ)/i,
          time: /(æ—¶é—´|æ—¶æ®µ|time)/i
        }[name];
        return cols.find(c=>pat.test(c));
      }

      // auto-fill selects
      mapping.querySelectorAll('select').forEach(sel=>{
        const k = sel.getAttribute('data-key');
        const g = guessCol(k);
        if (g) sel.value = g;
      });

      // replace apply button behavior
      document.getElementById('applyImport').onclick = ()=>{
        const getSel = k => mapping.querySelector(`select[data-key="${k}"]`).value || guessCol(k) || '';
        const sel = { course:getSel('course'), teacher:getSel('teacher'), room:getSel('room'), weekday:getSel('weekday'), period:getSel('period'), time:getSel('time') };
        if (!sel.course){ alert('è¯·è‡³å°‘æŒ‡å®šâ€œè¯¾ç¨‹åç§°â€åˆ—ã€‚'); return; }

        function normalizeWeekday(v){
          const s = String(v||'').trim();
          const map = {'ä¸€':1,'äºŒ':2,'ä¸‰':3,'å››':4,'äº”':5,'å…­':6,'æ—¥':7,'å¤©':7};
          let m = s.match(/([ä¸€äºŒä¸‰å››äº”å…­æ—¥å¤©])/); if (m) return [map[m[1]], 'å‘¨'+m[1]];
          m = s.match(/([1-7])/); if (m) return [parseInt(m[1]), weekdayNames[parseInt(m[1])]];
          return [null,null];
        }
        function normalizePeriod(v){
          const s = String(v||'').trim();
          const m = s.match(/(\d{1,2})(?:-(\d{1,2}))?/);
          return m ? (m[2] ? `${m[1]}-${m[2]}` : m[1]) : (s||null);
        }

        // detect wide format (å‘¨ä¸€..å‘¨æ—¥ä¸ºåˆ—å)
        const dayCols = cols.filter(c=>/(^å‘¨[ä¸€äºŒä¸‰å››äº”å…­æ—¥å¤©1-7]$)|(^æ˜ŸæœŸ[ä¸€äºŒä¸‰å››äº”å…­æ—¥å¤©]$)/.test(c));
        let newData = [];
        if (!sel.weekday && dayCols.length >= 1){
          // melt
          const idCols = cols.filter(c=>!dayCols.includes(c));
          rows.forEach(r=>{
            dayCols.forEach(dc=>{
              const cell = r[dc];
              if (cell && String(cell).trim()!==''){
                // split lines: è¯¾ç¨‹;æ•™å¸ˆ;æ•™å®¤
                const parts = String(cell).split(/[\nï¼›;]+/).map(x=>x.trim()).filter(Boolean);
                const obj = { course: parts[0]||'', teacher: parts[1]||'', room: parts[2]||'', weekday_label: dc.replace(/^æ˜ŸæœŸ/,'å‘¨'), weekday_num: weekdayNames.indexOf(dc.replace(/^æ˜ŸæœŸ/,'å‘¨')) };
                if (sel.period) obj.period = normalizePeriod(r[sel.period]);
                newData.push(obj);
              }
            });
          });
        } else {
          rows.forEach(r=>{
            const course = r[sel.course];
            if (!course || String(course).trim()==='') return;
            let weekday_num = null, weekday_label = null;
            if (sel.weekday){
              const pair = normalizeWeekday(r[sel.weekday]); weekday_num = pair[0]; weekday_label = pair[1];
            }
            newData.push({
              course: String(course),
              teacher: sel.teacher ? String(r[sel.teacher]||'') : '',
              room: sel.room ? String(r[sel.room]||'') : '',
              weekday_num, weekday_label,
              period: sel.period ? normalizePeriod(r[sel.period]) : null
            });
          });
        }
        data = newData;
        refreshFacetOptions(); render();
        document.getElementById('importDlg').close();
      };
    });

    // ---------- ICS export ----------
    document.getElementById('icsBtn').addEventListener('click', ()=>{
      // build period table UI with detected periods
      const pt = $('#periodTable'); pt.innerHTML='';
      const periods = uniq(filterData().map(x=>parsePeriodLabel(x.period)?.start).filter(Boolean)).sort((a,b)=>a-b);
      const toRender = periods.length ? periods : [1,2,3,4,5,6,7,8,9,10,11,12];
      toRender.forEach(p=>{
        const [st, et] = defaultTimes[p] || ['08:00','08:45'];
        pt.insertAdjacentHTML('beforeend', `<div class="flex items-center gap-2">
          <div class="w-10 text-sm text-slate-300">ç¬¬${p}èŠ‚</div>
          <input data-p="${p}" data-k="start" value="${st}" class="w-24 px-2 py-1 bg-white/10 rounded" placeholder="HH:MM">
          <span>â€”</span>
          <input data-p="${p}" data-k="end" value="${et}" class="w-24 px-2 py-1 bg-white/10 rounded" placeholder="HH:MM">
        </div>`);
      });
      $('#icsDlg').showModal();
    });

    function dtToLocalICS(date, timeHHMM){
      const [hh,mm] = timeHHMM.split(':').map(x=>parseInt(x,10));
      const d = new Date(date); d.setHours(hh, mm, 0, 0);
      // ICS uses local time in DTSTART/DTEND without 'Z' when TZID provided at calendar level or in property.
      return `${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}${String(d.getDate()).padStart(2,'0')}T${String(d.getHours()).padStart(2,'0')}${String(d.getMinutes()).padStart(2,'0')}00`;
    }

    function mondayOf(date){
      const d = new Date(date);
      const wd = d.getDay(); // 0=Sun..6=Sat
      const diff = (wd===0 ? -6 : 1-wd);
      d.setDate(d.getDate()+diff);
      d.setHours(0,0,0,0);
      return d;
    }

    function generateICS(){
      const termStart = $('#termStart').value; if(!termStart){ alert('è¯·å…ˆé€‰æ‹©å­¦æœŸå¼€å§‹æ—¥æœŸ'); return null; }
      const weeks = parseInt($('#termWeeks').value||'16',10);
      const tz = $('#tz').value || 'Asia/Shanghai';

      // collect period times
      const times = {...defaultTimes};
      document.querySelectorAll('#periodTable input').forEach(inp=>{
        const p = parseInt(inp.getAttribute('data-p'),10);
        const k = inp.getAttribute('data-k');
        times[p] = times[p] || ['08:00','08:45'];
        times[p][k==='start'?0:1] = inp.value || times[p][k==='start'?0:1];
      });

      const items = filterData();
      const mon = mondayOf(new Date(termStart));
      let ics = 'BEGIN:VCALENDAR\r\nVERSION:2.0\r\nCALSCALE:GREGORIAN\r\nPRODID:-//Interactive Timetable//CN\r\n';
      items.forEach((it, idx)=>{
        const wd = it.weekday_num || 1;
        const periodObj = parsePeriodLabel(it.period) || {start:1,end:2};
        const [startTime,] = times[periodObj.start] || ['08:00','08:45'];
        const [, endTime] = times[periodObj.end] || ['08:00','08:45'];
        // date = Monday + (wd-1) days
        const eventDate = new Date(mon); eventDate.setDate(mon.getDate() + (wd-1));
        const dtStart = dtToLocalICS(eventDate, startTime);
        const dtEnd = dtToLocalICS(eventDate, endTime);
        const uid = `tt-${Date.now()}-${idx}@local`;
        const sum = `${it.course}${it.room? ' @'+it.room:''}`;
        const desc = `${it.course}${it.teacher? '\\næ•™å¸ˆ: '+it.teacher:''}${it.room? '\\næ•™å®¤: '+it.room:''}${it.period? '\\nèŠ‚æ¬¡: '+it.period:''}`.replace(/\n/g,'\\n');

        ics += `BEGIN:VEVENT\r\nUID:${uid}\r\nDTSTAMP:${dtStart}\r\nSUMMARY:${sum}\r\nDESCRIPTION:${desc}\r\n`;
        ics += `DTSTART;TZID=${tz}:${dtStart}\r\nDTEND;TZID=${tz}:${dtEnd}\r\n`;
        ics += `RRULE:FREQ=WEEKLY;COUNT=${weeks}\r\n`;
        if (it.room) ics += `LOCATION:${it.room}\r\n`;
        ics += 'END:VEVENT\r\n';
      });
      ics += 'END:VCALENDAR\r\n';
      return ics;
    }

    document.getElementById('exportICS').addEventListener('click', ()=>{
      const ics = generateICS(); if(!ics) return;
      const blob = new Blob([ics], {type:'text/calendar;charset=utf-8'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'è¯¾ç¨‹è¡¨.ics';
      document.body.appendChild(a); a.click(); a.remove();
      document.getElementById('icsDlg').close();
    });
  </script>
</body>
</html>
